<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>My Zone - Ofertas en Apps y Cuentas Premium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Compra aplicaciones y cuentas premium con ofertas activas en My Zone. Moderno, rápido y seguro." />
  <meta name="keywords" content="apps, cuentas premium, ofertas, Spotify, juegos, compra online, tailwind css" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body.no-scroll { overflow: hidden; }
    .title-shine { position: relative; overflow: hidden; }
    .title-shine::before {
      content: ''; position: absolute; top: 0; left: -150%;
      width: 50%; height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.4), transparent);
      transform: skewX(-25deg);
      animation: shine 3s infinite linear;
    }
    @keyframes shine { 0% { left: -150%; } 100% { left: 250%; } }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Estilos para los modales */
    .modal-backdrop {
        transition: opacity 0.3s ease-in-out;
    }
    .modal-content {
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    }

    /* Estilo para el botón de compra con efecto de brillo */
    .shiny-btn {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #06b6d4, #22d3ee);
      z-index: 1;
    }
    .shiny-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 25%;
      height: 100%;
      background: rgba(255, 255, 255, 0.5);
      transform: skewX(-20deg);
      transition: all 0.5s ease-in-out;
    }
    .shiny-btn:hover::before {
      left: 150%;
    }

    /* Estilos para el rating de estrellas */
    .star-rating {
        display: flex;
        gap: 2px;
    }
    .star-rating .star {
        cursor: pointer;
        font-size: 1.5rem;
        color: #eab308; /* Color de estrella dorada */
        transition: transform 0.2s;
    }
    .star-rating.read-only .star {
        cursor: default;
    }
    .star-rating.read-only .star.filled,
    .star-rating .star.filled {
        color: #eab308;
    }
    .star-rating.read-only .star.unfilled,
    .star-rating .star.unfilled {
        color: #6b7280; /* Color gris */
    }
    
    /* Animación para el banner de oferta */
    @keyframes pulse-sale {
        0%, 100% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.05) rotate(2deg); }
    }
    .offer-banner {
        animation: pulse-sale 2s infinite;
    }

    /* Animación para el botón de bienvenida */
    .cta-button-anim {
        animation: pulse-glow 2s infinite;
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); }
    }

    /* Estilos para la tarjeta de oferta flash */
    @keyframes flash-glow {
        0% { box-shadow: 0 0 5px 2px rgba(251, 113, 133, 0.5); }
        50% { box-shadow: 0 0 20px 8px rgba(251, 113, 133, 0.8); }
        100% { box-shadow: 0 0 5px 2px rgba(251, 113, 133, 0.5); }
    }
    .flash-offer-card {
        animation: flash-glow 2s infinite;
        border: 2px solid #f87171;
    }
    
    /* Badge de oferta flash más grande y con animación */
    @keyframes pulse-flash-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .flash-offer-badge {
        animation: pulse-flash-badge 1.5s infinite;
        font-size: 0.875rem; /* text-sm */
        padding: 0.5rem 1rem; /* p-2 p-4 */
        border-radius: 9999px; /* rounded-full */
        background-color: #f87171; /* bg-red-400 */
        color: white;
    }

    /* Estilo para la tarjeta de oferta flash en la página de ofertas */
    .offer-card.flash-offer-card-bg {
        background: linear-gradient(135deg, #f87171, #be123c);
        border: 2px solid #fca5a5;
        box-shadow: 0 0 25px rgba(251, 113, 133, 0.5);
    }
    .offer-card.flash-offer-card-bg .offer-price {
        color: #ffedd5; /* Color más claro para el precio */
    }

    /* ESTILOS PARA LA SECCIÓN DE BIENVENIDA */
    .hero-title {
      font-size: clamp(2rem, 8vw, 5rem);
      line-height: 1.1;
      font-weight: 900;
      background: linear-gradient(45deg, #06b6d4, #22d3ee, #be123c, #f87171);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: gradient-flow 6s ease infinite;
    }
    @keyframes gradient-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .welcome-container {
      transition: opacity 0.5s ease-in-out;
    }
    
    /* ESTILOS PARA OCULTAR EL ENCABEZADO Y EL SCROLL INICIALMENTE */
    body.welcome-active {
        overflow-y: hidden;
    }
    body.welcome-active #main-header {
        opacity: 0;
        transform: translateY(-100%);
        visibility: hidden;
    }
    header {
        transition: all 0.3s ease-in-out;
    }
    
    /* ICONO DE BIENVENIDA ANIMADO */
    @keyframes bounce-icon {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-10px) scale(1.1); }
    }
    .welcome-icon {
        animation: bounce-icon 2s ease-in-out infinite;
    }

    /* Estilos para el icono de campana con badge */
    /* ELIMINADO: Esta sección de estilos ha sido eliminada */
  </style>
</head>
<body class="bg-zinc-900 text-gray-200 antialiased flex flex-col welcome-active">

  <header id="main-header" class="bg-black/30 backdrop-blur-sm sticky top-0 z-20 shadow-lg shadow-cyan-500/5">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 sm:gap-6">
      <h1 class="text-2xl sm:text-3xl font-black tracking-wider text-white title-shine truncate flex-grow text-center sm:text-left min-w-0">My Zone</h1>
      <nav role="navigation" class="items-center justify-center sm:justify-end gap-2 md:gap-4 flex-wrap flex-shrink-0 mt-2 sm:mt-0 flex">
        <a href="#apps" class="nav-link text-sm md:text-base font-semibold text-gray-300 hover:text-cyan-400 transition-colors" data-section="apps">Apps</a>
        <a href="#cuentas" class="nav-link text-sm md:text-base font-semibold text-gray-300 hover:text-cyan-400 transition-colors" data-section="cuentas">Cuentas</a>
        <a href="#ofertas" id="offers-nav-link" class="nav-link text-sm md:text-base font-semibold text-white bg-cyan-600 hover:bg-cyan-700 px-3 py-1.5 rounded-lg transition-colors" data-section="ofertas">
            Ofertas
        </a>
        <a href="#flash-ofertas" id="flash-offers-nav-link" class="nav-link text-sm md:text-base font-semibold text-white bg-rose-600 hover:bg-rose-700 px-3 py-1.5 rounded-lg transition-colors" data-section="flash-ofertas">
             🔥 Oferta Flash
        </a>
        <button id="simulate-event-btn" class="hidden md:block text-xs md:text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-lg transition-colors">
            Simular Evento
        </button>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 md:py-12 flex-grow">
    
    <section id="welcome-section" class="welcome-container fixed inset-0 flex flex-col items-center justify-center p-4 z-30 bg-zinc-900 text-center transition-all duration-500">
        <div class="welcome-icon text-cyan-400 mb-6" style="width: 80px; height: 80px;">
             <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
        </div>
        <h1 class="hero-title font-black mb-4">
            My Zone: Tu Puerta de Acceso a Ofertas Exclusivas
        </h1>
        <p class="text-xl md:text-2xl text-zinc-400 max-w-3xl mb-8 font-semibold">
            Bienvenido a la plataforma donde la **innovación** se encuentra con los **precios imbatibles**. Explora un catálogo selecto de aplicaciones y cuentas premium con descuentos inigualables.
        </p>
        <button id="start-Browse-btn" class="px-8 py-4 rounded-full text-lg font-bold text-zinc-900 bg-cyan-400 hover:bg-cyan-300 transition-all transform hover:scale-105 cta-button-anim">
            Comienza a Explorar
        </button>
    </section>

    <section id="general-products-section" class="hidden">
      <h2 class="text-2xl md:text-3xl font-bold text-white mb-8">Todos nuestros productos</h2>
      <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
          </div>
      <p id="no-results" class="text-center text-zinc-400 hidden">No se encontraron productos que coincidan con tu búsqueda.</p>
    </section>

    <section id="regular-offers-page" class="hidden">
      <div class="p-6 md:p-8 bg-zinc-900 rounded-2xl">
          <h2 class="text-3xl md:text-4xl font-black text-white flex items-center gap-2 mb-6">
              Ofertas de la semana
          </h2>
          <div id="regular-offers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              </div>
          <p id="no-regular-offers-message" class="text-center text-zinc-400 mt-4 hidden">No hay ofertas activas en este momento.</p>
      </div>
    </section>

    <section id="flash-offers-page" class="hidden">
      <div class="p-6 md:p-8 bg-zinc-900 rounded-2xl">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6">
              <h2 class="text-3xl md:text-4xl font-black text-white flex items-center gap-2">
                  🔥 Ofertas Relámpago 🔥
              </h2>
              <div class="mt-4 md:mt-0 flex items-center gap-2">
                  <p class="text-lg text-rose-400 font-semibold">Termina en:</p>
                  <div id="countdown-timer" class="flex items-center gap-1 text-2xl font-mono text-white bg-red-600 px-3 py-1 rounded-lg">
                      <span>00</span>:<span>00</span>:<span>00</span>
                  </div>
              </div>
          </div>
          <div id="flash-offers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              </div>
          <p id="no-flash-offers-message" class="text-center text-zinc-400 mt-4 hidden">No hay ofertas relámpago activas en este momento.</p>
      </div>
    </section>

  </main>

  <footer class="bg-zinc-900/50 border-t border-zinc-800 text-center py-6 hidden">
    <p class="text-zinc-500 text-sm">
      <a href="#" class="text-cyan-500 hover:underline">Política de Privacidad</a> | © 2025 My Zone
    </p>
  </footer>

  <template id="product-card-template">
    <div class="card bg-zinc-800/50 border border-zinc-700 rounded-2xl p-5 flex flex-col transition-all duration-300 hover:transform hover:-translate-y-2 hover:shadow-2xl hover:shadow-cyan-500/20 cursor-pointer relative overflow-hidden">
      <div class="product-featured-banner hidden absolute top-4 -right-10 bg-amber-400 text-zinc-900 font-bold text-xs px-10 py-1 transform rotate-45">DESTACADO</div>
      <img class="product-image w-full h-48 object-contain rounded-lg mb-4 bg-zinc-800" src="" alt="" loading="lazy">
      <div class="flex-grow flex flex-col">
        <h3 class="product-name text-xl font-bold text-white mb-2"></h3>
        <div class="flex items-center justify-between mb-4">
            <div class="product-offer bg-cyan-400/10 text-cyan-300 text-xs font-bold px-3 py-1 rounded-full hidden"></div>
            <div class="product-sales-counter text-xs text-green-400 font-semibold bg-green-900/40 px-2 py-0.5 rounded-full hidden"></div>
            </div>
        <div class="flex items-center gap-2 mb-2">
            <div class="star-rating read-only flex gap-1 text-yellow-400 text-base"></div>
            <span class="review-count text-zinc-400 text-sm">(0)</span>
        </div>
        <div class="flex items-baseline gap-3 mt-auto pt-4">
            <p class="product-price text-3xl font-bold text-cyan-400"></p>
            <p class="product-original-price text-lg text-zinc-500 line-through"></p>
        </div>
      </div>
    </div>
  </template>
  
  <template id="offer-card-template">
      <div class="offer-card bg-zinc-700/50 rounded-2xl p-6 flex flex-col transition-all duration-300 hover:scale-[1.02] cursor-pointer">
          <img class="offer-image w-full h-36 object-contain rounded-lg bg-zinc-800 flex-shrink-0 mb-4" src="" alt="" loading="lazy">
          <div class="flex-grow flex flex-col items-center text-center">
              <h3 class="offer-name text-xl font-bold text-white mb-2"></h3>
              <div class="flex items-baseline gap-2 mb-2">
                  <p class="offer-price text-4xl font-black text-rose-400"></p>
                  <p class="offer-original-price text-lg text-zinc-400 line-through"></p>
              </div>
              <div class="offer-discount bg-red-600 font-bold text-white px-3 py-1 rounded-full text-sm offer-banner inline-block mb-4"></div>
          </div>
          <button class="buy-offer-btn shiny-btn text-zinc-900 font-bold px-4 py-3 rounded-lg w-full mt-auto">
              ¡Comprar ya!
          </button>
      </div>
  </template>
  
  <div id="product-modal" class="modal-backdrop fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-30 opacity-0 pointer-events-none">
    <div class="modal-content bg-zinc-800 rounded-2xl shadow-2xl shadow-cyan-900/50 w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0">
        </div>
  </div>

  <div id="reviews-modal" class="modal-backdrop fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-40 opacity-0 pointer-events-none">
    <div class="modal-content bg-zinc-900 rounded-2xl shadow-2xl shadow-cyan-900/50 w-full max-w-3xl max-h-[95vh] overflow-y-auto transform scale-95 opacity-0">
      <div id="reviews-modal-content" class="p-4 md:p-6">
        </div>
    </div>
  </div>
  
  <div id="review-form-modal" class="modal-backdrop fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
    <div class="modal-content bg-zinc-900 rounded-2xl shadow-2xl shadow-cyan-900/50 w-full max-w-lg transform scale-95 opacity-0">
        <div id="review-form-modal-content" class="p-4 md:p-6">
            </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transition-all duration-500 opacity-0 translate-y-10 pointer-events-none z-40">
    <span id="toast-message"></span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      
      // --- DATOS INICIALES (hardcoded) ---
      // Los datos ahora se almacenan como un array plano para facilitar la manipulación.
      const initialProducts = [
        {
          id: 'spotify-mod', name: 'Spotify Premium Mod', featured: true, type: 'apps',
          description: 'Disfruta de música sin anuncios y saltos ilimitados. Accede a tu contenido favorito sin interrupciones.',
          price: 3.00, originalPrice: 3.00, simulatedSales: 15,
          image: 'https://i.ibb.co/XyD8Pz8/spotify-premium-mod.jpg',
          reviews: [
              { rating: 5, comment: 'Funciona genial, me encanta poder escuchar música sin anuncios.', author: 'Serena L.', userImage: 'https://placehold.co/48x48/10b981/ffffff?text=SL' },
              { rating: 4, comment: 'Muy buen precio para las funciones que ofrece, pero a veces tarda en cargar.', author: 'Liam K.', userImage: 'https://placehold.co/48x48/4338ca/ffffff?text=LK' },
              { rating: 5, comment: '¡Increíble! La mejor compra que he hecho para mi música. ¡Funciona perfecto!', author: 'Aurora G.', userImage: 'https://placehold.co/48x48/d97706/ffffff?text=AG' }
          ]
        },
        {
          id: 'youtube-premium', name: 'YouTube Premium', featured: true, type: 'apps',
          description: 'Videos sin anuncios, reproducción en segundo plano y acceso a YouTube Music. Una experiencia de visualización ininterrumpida en todos tus dispositivos.',
          price: 4.50, originalPrice: 12.00, simulatedSales: 8,
          image: 'https://placehold.co/400x200/ef4444/white?text=YouTube',
          reviews: [
              { rating: 5, comment: 'La mejor forma de ver YouTube sin interrupciones.', author: 'Alia V.', userImage: 'https://placehold.co/48x48/0d9488/ffffff?text=AV' },
              { rating: 5, comment: 'Precio inmejorable. Lo recomiendo al 100%.', author: 'Draco M.', userImage: 'https://placehold.co/48x48/1d4ed8/ffffff?text=DM' },
              { rating: 4, comment: 'Funciona muy bien en mi móvil y tablet, aunque a veces falla en la tele. Buena compra.', author: 'Nox P.', userImage: 'https://placehold.co/48x48/a21caf/ffffff?text=NP' }
          ]
        },
        {
          id: 'netflix-premium', name: 'Netflix Premium', type: 'apps',
          description: 'Acceso a una cuenta de Netflix Premium con la mejor calidad de vídeo y 4K UHD. Disfruta de series y películas sin límites.',
          price: 10.00, originalPrice: 20.00, simulatedSales: 0,
          image: 'https://placehold.co/400x200/e50914/white?text=Netflix',
          reviews: [
              { rating: 3, comment: 'La calidad es buena, pero tardaron un día en darme el acceso.', author: 'Astrid D.', userImage: 'https://placehold.co/48x48/e50914/ffffff?text=AD' },
              { rating: 5, comment: 'El servicio al cliente resolvió mi problema de acceso rápidamente. Muy contenta.', author: 'Zane L.', userImage: 'https://placehold.co/48x48/000000/ffffff?text=ZL' }
          ]
        },
        {
          id: 'last-day-on-earth', name: 'Cuenta Last Day On Earth', featured: true, type: 'cuentas',
          description: 'Acceso completo con nivel avanzado, recursos ilimitados y beneficios exclusivos en el juego. Empieza a jugar como un profesional desde el primer día.',
          price: 2.99, originalPrice: 5.00, simulatedSales: 22,
          image: 'https://i.ibb.co/Zp97qWTr/last-day-on-earth-premium.jpg',
          reviews: [
              { rating: 5, comment: '¡Increíble! Ahorré mucho tiempo de farmeo. La cuenta es brutal.', author: 'Jaxon S.', userImage: 'https://placehold.co/48x48/0f766e/ffffff?text=JS' },
              { rating: 5, comment: 'La cuenta tenía todos los recursos que prometían. Fantástico.', author: 'Ember M.', userImage: 'https://placehold.co/48x48/f97316/ffffff?text=EM' },
              { rating: 4, comment: 'Muy buena cuenta, pero me gustaría que el precio fuera un poco más bajo.', author: 'Orion V.', userImage: 'https://placehold.co/48x48/65a30d/ffffff?text=OV' }
          ]
        },
         {
          id: 'disney-plus', name: 'Cuenta Disney+', type: 'cuentas',
          description: 'Acceso a una cuenta de Disney+ por 1 año. Disfruta de todo el catálogo de Disney, Pixar, Marvel, Star Wars y National Geographic sin límites.',
          price: 15.00, originalPrice: 89.99, simulatedSales: 3,
          image: 'https://placehold.co/400x200/1e40af/white?text=Disney%2B',
          reviews: [
              { rating: 4, comment: 'El servicio es muy bueno, pero me gustaría que la oferta durara más.', author: 'Willow J.', userImage: 'https://placehold.co/48x48/3730a3/ffffff?text=WJ' },
              { rating: 5, comment: '¡Me encanta! Me llegó el acceso en solo 10 minutos.', author: 'Rhys A.', userImage: 'https://placehold.co/48x48/e11d48/ffffff?text=RA' }
          ]
        }
      ];

      // --- REFERENCIAS AL DOM ---
      const welcomeSection = document.getElementById('welcome-section');
      const generalProductsSection = document.getElementById('general-products-section');
      const regularOffersPage = document.getElementById('regular-offers-page');
      const flashOffersPage = document.getElementById('flash-offers-page');
      const navLinks = document.querySelectorAll('.nav-link');
      const cardTemplate = document.getElementById('product-card-template');
      const offerCardTemplate = document.getElementById('offer-card-template');
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const noResultsMsg = document.getElementById('no-results');
      const productModal = document.getElementById('product-modal');
      const productModalContent = productModal.querySelector('.modal-content');
      const reviewsModal = document.getElementById('reviews-modal');
      const reviewsModalContent = document.getElementById('reviews-modal-content');
      const reviewFormModal = document.getElementById('review-form-modal');
      const reviewFormModalContent = document.getElementById('review-form-modal-content');
      const regularOffersGrid = document.getElementById('regular-offers-grid');
      const flashOffersGrid = document.getElementById('flash-offers-grid');
      const noRegularOffersMessage = document.getElementById('no-regular-offers-message');
      const noFlashOffersMessage = document.getElementById('no-flash-offers-message');
      const simulateEventBtn = document.getElementById('simulate-event-btn');
      const startBrowseBtn = document.getElementById('start-Browse-btn');
      const countdownTimer = document.getElementById('countdown-timer');
      const mainGrid = document.getElementById('product-grid');
      const mainHeader = document.getElementById('main-header');
      const mainFooter = document.querySelector('footer');
      const body = document.body;
      
      let currentSection = 'home'; // Nueva sección de inicio por defecto
      const allProducts = [...initialProducts];
      let countdownInterval;
      let flashOfferProduct = null;
      let flashOfferTimeout;
      
      // Variable para controlar la actualización de ventas
      let salesUpdateInterval;
      
      // Variables para los nuevos sistemas de notificaciones y reseñas
      let purchasedProducts = JSON.parse(localStorage.getItem('purchasedProducts')) || [];
      let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
      let userReviews = JSON.parse(localStorage.getItem('userReviews')) || {};
      
      // --- FUNCIONES DE UTILIDAD ---

      const showToast = (message, type = 'success') => {
        toastMessage.textContent = message;
        toast.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg font-semibold transition-all duration-500 z-40';
        toast.classList.add(type === 'success' ? 'bg-green-600' : 'bg-red-600');
        setTimeout(() => toast.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none'), 100);
        setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none'), 3000);
      };

      const calculateAverageRating = (reviews) => {
          if (!reviews || reviews.length === 0) return 0;
          const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
          return totalRating / reviews.length;
      };

      const renderStarRating = (container, rating) => {
          container.innerHTML = '';
          const roundedRating = Math.round(rating);
          const totalStars = 5;

          for (let i = 1; i <= totalStars; i++) {
              const starSpan = document.createElement('span');
              starSpan.textContent = '★';
              starSpan.classList.add('star');
              if (i <= roundedRating) {
                  starSpan.classList.add('filled');
              } else {
                  starSpan.classList.add('unfilled');
              }
              container.appendChild(starSpan);
          }
      };
      
      /**
       * Inicia el contador de tiempo para la oferta flash.
       * Se llama solo cuando se navega a la página de ofertas flash.
       */
      const startCountdown = () => {
          let totalSeconds = 15 * 60; // 15 minutos de oferta
          clearInterval(countdownInterval);
          countdownInterval = setInterval(() => {
              const minutes = Math.floor(totalSeconds / 60);
              const seconds = totalSeconds % 60;
              countdownTimer.innerHTML = `<span>${String(minutes).padStart(2, '0')}</span>:<span>${String(seconds).padStart(2, '0')}</span>`;
              if (totalSeconds <= 0) {
                  clearInterval(countdownInterval);
                  // Desactiva la oferta flash
                  if (flashOfferProduct) {
                    flashOfferProduct.flashOffer = null;
                    flashOfferProduct = null;
                  }
                  showToast('¡La oferta relámpago ha terminado!', 'error');
                  currentSection = 'apps'; // Vuelve a la página de inicio de apps
                  renderContent();
                  updateActiveLink();
              }
              totalSeconds--;
          }, 1000);
      };

      /**
       * Simula la actualización de ventas en tiempo real.
       * Actualiza las ventas de un producto aleatorio cada 5 segundos.
       */
      const updateSalesCounters = () => {
          clearInterval(salesUpdateInterval);
          salesUpdateInterval = setInterval(() => {
              // Actualiza entre 1 y 3 productos en cada intervalo
              const productsToUpdateCount = Math.floor(Math.random() * 3) + 1;
              const productsToUpdate = [...allProducts].sort(() => 0.5 - Math.random()).slice(0, productsToUpdateCount);
              
              productsToUpdate.forEach(product => {
                  const change = Math.floor(Math.random() * 3) - 1; // -1, 0, o 1
                  product.simulatedSales = Math.max(0, product.simulatedSales + change);
              });

              // Solo volvemos a renderizar si estamos en una sección que muestra productos
              if (currentSection !== 'home') {
                  renderContent();
              }
          }, 5000); // Actualiza cada 5 segundos
      };

      // --- FUNCIONES PRINCIPALES ---
      
      const renderProductList = (products, container, template) => {
        container.innerHTML = '';
        products.forEach(product => {
          const card = template.content.cloneNode(true);
          const cardElement = card.querySelector('.card');

          let effectivePrice = product.price;
          let effectiveOriginalPrice = product.originalPrice;
          
          const offerLabel = card.querySelector('.product-offer');
          
          const discount = Math.round(((effectiveOriginalPrice - effectivePrice) / effectiveOriginalPrice) * 100);
          
          if (product.featured) {
            card.querySelector('.product-featured-banner').classList.remove('hidden');
          }
          
          card.querySelector('.product-image').src = product.image;
          card.querySelector('.product-image').alt = product.name;
          card.querySelector('.product-name').textContent = product.name;
          card.querySelector('.product-price').textContent = `${effectivePrice.toFixed(2)}€`;
          
          const originalPriceElement = card.querySelector('.product-original-price');
          if (effectivePrice < effectiveOriginalPrice) {
            originalPriceElement.textContent = `${effectiveOriginalPrice.toFixed(2)}€`;
            originalPriceElement.classList.remove('hidden');
            if (offerLabel) { 
                offerLabel.textContent = `OFERTA -${discount}%`;
                offerLabel.classList.remove('hidden');
            }
          } else {
            originalPriceElement.classList.add('hidden');
            if (offerLabel) offerLabel.classList.add('hidden');
          }
          
          const salesCounter = card.querySelector('.product-sales-counter');
          if (salesCounter && product.simulatedSales > 0) {
              salesCounter.textContent = `${product.simulatedSales} vendidos en la última hora`;
              salesCounter.classList.remove('hidden');
          } else if (salesCounter) {
              salesCounter.classList.add('hidden');
          }
          
          const avgRating = calculateAverageRating(product.reviews);
          const starRatingContainer = card.querySelector('.star-rating');
          if (starRatingContainer) {
              renderStarRating(starRatingContainer, avgRating);
              card.querySelector('.review-count').textContent = `(${product.reviews.length})`;
          }
          
          cardElement.dataset.productId = product.id;
          container.appendChild(card);
        });
      };
      
      const renderRegularOffersPage = () => {
          const productsWithRegularOffer = allProducts.filter(p => p.price < p.originalPrice && !p.flashOffer);
          regularOffersGrid.innerHTML = '';

          if (productsWithRegularOffer.length === 0) {
              noRegularOffersMessage.classList.remove('hidden');
          } else {
              noRegularOffersMessage.classList.add('hidden');
              productsWithRegularOffer.forEach(product => {
                  const card = offerCardTemplate.content.cloneNode(true);
                  const offerCardElement = card.querySelector('.offer-card');
                  
                  const discount = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);

                  card.querySelector('.offer-image').src = product.image;
                  card.querySelector('.offer-image').alt = product.name;
                  card.querySelector('.offer-name').textContent = product.name;
                  card.querySelector('.offer-price').textContent = `${product.price.toFixed(2)}€`;
                  card.querySelector('.offer-original-price').textContent = `${product.originalPrice.toFixed(2)}€`;
                  card.querySelector('.offer-discount').textContent = `-${discount}%`;

                  const buyBtn = card.querySelector('.buy-offer-btn');
                  buyBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      openProductModal(product);
                  });
                  
                  offerCardElement.dataset.productId = product.id;
                  offerCardElement.addEventListener('click', (e) => {
                      if (!e.target.closest('.buy-offer-btn')) {
                           openProductModal(product);
                      }
                  });
                  
                  regularOffersGrid.appendChild(card);
              });
          }
          clearInterval(countdownInterval); // Asegura que el contador no corra en esta página
      };

      const renderFlashOffersPage = () => {
          const productsWithFlashOffer = allProducts.filter(p => p.flashOffer && p.flashOffer.isFlashOffer);
          flashOffersGrid.innerHTML = '';
          
          if (productsWithFlashOffer.length === 0) {
              noFlashOffersMessage.classList.remove('hidden');
          } else {
              noFlashOffersMessage.classList.add('hidden');
              productsWithFlashOffer.forEach(product => {
                  const card = offerCardTemplate.content.cloneNode(true);
                  const offerCardElement = card.querySelector('.offer-card');
                  
                  // Aplica los estilos de la oferta flash
                  offerCardElement.classList.add('flash-offer-card-bg');

                  const effectivePrice = product.originalPrice * (1 - product.flashOffer.flashDiscount);
                  const discount = Math.round(((product.originalPrice - effectivePrice) / product.originalPrice) * 100);

                  card.querySelector('.offer-image').src = product.image;
                  card.querySelector('.offer-image').alt = product.name;
                  card.querySelector('.offer-name').textContent = product.name;
                  card.querySelector('.offer-price').textContent = `${effectivePrice.toFixed(2)}€`;
                  card.querySelector('.offer-original-price').textContent = `${product.originalPrice.toFixed(2)}€`;
                  card.querySelector('.offer-discount').textContent = `-${discount}%`;

                  const buyBtn = card.querySelector('.buy-offer-btn');
                  buyBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      openProductModal(product);
                  });
                  
                  offerCardElement.dataset.productId = product.id;
                  offerCardElement.addEventListener('click', (e) => {
                      if (!e.target.closest('.buy-offer-btn')) {
                           openProductModal(product);
                      }
                  });
                  
                  flashOffersGrid.appendChild(card);
              });
          }
          startCountdown(); // Inicia el contador solo para esta página
      };
      
      const toggleInterfaceVisibility = (show) => {
          if (show) {
              body.classList.remove('welcome-active');
              welcomeSection.classList.add('hidden');
              mainFooter.classList.remove('hidden');
              body.classList.remove('no-scroll');
          } else {
              body.classList.add('welcome-active');
              welcomeSection.classList.remove('hidden');
              mainFooter.classList.add('hidden');
              body.classList.add('no-scroll');
          }
      };

      const renderContent = () => {
        // Ocultar todas las secciones de contenido
        generalProductsSection.classList.add('hidden');
        regularOffersPage.classList.add('hidden');
        flashOffersPage.classList.add('hidden');

        // Lógica para mostrar la sección correcta
        if (currentSection === 'home') {
            toggleInterfaceVisibility(false);
        } else {
            toggleInterfaceVisibility(true);
            if (currentSection === 'ofertas') {
                regularOffersPage.classList.remove('hidden');
                renderRegularOffersPage();
            } else if (currentSection === 'flash-ofertas') {
                flashOffersPage.classList.remove('hidden');
                renderFlashOffersPage();
            } else {
                generalProductsSection.classList.remove('hidden');
                let productsToRender = allProducts.filter(p => !p.flashOffer);
                if (currentSection === 'apps') {
                    productsToRender = productsToRender.filter(p => p.type === 'apps');
                } else if (currentSection === 'cuentas') {
                    productsToRender = productsToRender.filter(p => p.type === 'cuentas');
                }
                
                noResultsMsg.classList.toggle('hidden', productsToRender.length > 0);
                renderProductList(productsToRender, mainGrid, cardTemplate);
            }
        }
      };

      const updateActiveLink = () => {
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('bg-cyan-600', 'hover:bg-cyan-700', 'text-white', 'text-cyan-400', 'bg-rose-600', 'hover:bg-rose-700');
          link.classList.add('text-gray-300', 'hover:text-cyan-400');
          if (link.dataset.section === currentSection) {
            if (link.id === 'offers-nav-link') {
                link.classList.add('bg-cyan-600', 'text-white');
                link.classList.remove('text-gray-300', 'hover:text-cyan-400');
            } else if (link.id === 'flash-offers-nav-link') {
                link.classList.add('bg-rose-600', 'text-white');
                link.classList.remove('text-gray-300', 'hover:text-cyan-400');
            } else {
                link.classList.add('text-cyan-400');
                link.classList.remove('text-gray-300');
            }
          }
        });
      };
      
      const isProductPurchased = (productId) => {
          return purchasedProducts.includes(productId);
      };

      const openProductModal = (product) => {
        let effectivePrice = product.price;
        if (product.flashOffer && product.flashOffer.isFlashOffer) {
            effectivePrice = product.originalPrice * (1 - product.flashOffer.flashDiscount);
        }

        const discount = Math.round(((product.originalPrice - effectivePrice) / product.originalPrice) * 100);
        const avgRating = calculateAverageRating(product.reviews);
        const isWished = wishlist.includes(product.id);
        const hasPurchased = isProductPurchased(product.id);

        productModalContent.innerHTML = `
            <div class="p-4 md:p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-white">${product.name}</h2>
                    <div class="flex gap-2">
                        <button id="add-to-wishlist-btn-modal" class="text-zinc-500 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${isWished ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                        </button>
                        <button id="close-product-modal-btn" class="text-zinc-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <img src="${product.image}" alt="${product.name}" class="w-full md:w-1/2 h-40 md:h-56 object-contain rounded-lg bg-zinc-700/50 flex-shrink-0">
                    <div class="flex-grow">
                        <p class="text-zinc-300 text-sm mb-4">${product.description}</p>
                        <div class="bg-zinc-900/50 rounded-lg p-3 mb-4">
                            <div class="flex items-baseline gap-2 mb-1">
                                <span id="modal-price" class="text-3xl font-bold text-cyan-400">${effectivePrice.toFixed(2)}€</span>
                                ${effectivePrice < product.originalPrice ? `<span class="text-lg text-zinc-500 line-through">${product.originalPrice.toFixed(2)}€</span>` : ''}
                            </div>
                            ${effectivePrice < product.originalPrice ? `<div class="text-green-400 text-sm font-semibold">Ahorras ${(product.originalPrice - effectivePrice).toFixed(2)}€ (${discount}%)</div>` : ''}
                        </div>
                        <div class="mb-4">
                            <label for="coupon-code" class="block text-sm font-medium text-zinc-400 mb-1">¿Tienes un cupón?</label>
                            <div class="flex gap-2">
                                <input type="text" id="coupon-code" placeholder="Ej: MYZONE10" class="flex-grow rounded-lg bg-zinc-700 text-white border border-zinc-600 px-3 py-2 text-sm focus:ring-2 focus:ring-cyan-500 focus:outline-none placeholder-zinc-500" />
                                <button id="apply-coupon-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm">Aplicar</button>
                            </div>
                            <p id="coupon-message" class="text-sm mt-2 hidden"></p>
                        </div>
                        <button class="btn-pago shiny-btn flex-grow text-zinc-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all hover:scale-105 disabled:bg-zinc-600 disabled:scale-100 w-full">
                            <span class="btn-text">Comprar Ahora</span>
                            <div class="spinner-container" style="display: none;"><div class="spinner h-5 w-5 border-2 border-zinc-900/20 border-t-zinc-900 rounded-full"></div></div>
                        </button>
                    </div>
                </div>
                
                <div id="reviews-preview-container" class="mt-6 pt-4 border-t border-zinc-700">
                    <h3 class="text-xl font-bold text-white mb-3 flex items-center justify-between">
                        Reseñas (${product.reviews.length})
                        <span id="see-all-reviews-btn" class="text-sm text-cyan-400 hover:underline cursor-pointer ${product.reviews.length > 0 ? '' : 'hidden'}">Ver todas</span>
                    </h3>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="star-rating read-only flex gap-1 text-yellow-400 text-lg">
                           ${'★'.repeat(Math.round(avgRating))}
                        </div>
                        <span class="text-zinc-400 text-sm">(${avgRating.toFixed(1)} de 5)</span>
                    </div>
                    <div id="reviews-summary" class="space-y-3">
                        </div>
                    <div class="mt-4">
                        <button id="leave-review-btn" class="bg-zinc-700 text-white font-semibold px-4 py-2 rounded-lg hover:bg-zinc-600 transition-colors text-sm w-full">
                            ${hasPurchased ? 'Escribir una reseña' : 'Compra el producto para dejar una reseña'}
                        </button>
                    </div>
                </div>
            </div>`;
        
        productModal.classList.remove('opacity-0', 'pointer-events-none');
        productModalContent.classList.remove('scale-95', 'opacity-0');
        body.classList.add('no-scroll');
        
        // Renderizar la reseña de ejemplo
        const reviewsSummary = document.getElementById('reviews-summary');
        if (product.reviews.length > 0) {
            const firstReview = product.reviews[0];
            reviewsSummary.innerHTML = `
                <div class="bg-zinc-900/50 rounded-lg p-4 border border-zinc-700">
                    <div class="flex items-center gap-2 mb-2">
                        <img src="${firstReview.userImage}" alt="${firstReview.author}" class="w-8 h-8 rounded-full">
                        <div>
                            <span class="block text-zinc-300 font-semibold">${firstReview.author}</span>
                            <div class="star-rating read-only flex gap-1 text-yellow-400 text-lg">
                                ${'★'.repeat(firstReview.rating)}
                            </div>
                        </div>
                    </div>
                    <p class="text-zinc-300 line-clamp-2">${firstReview.comment}</p>
                </div>
            `;
        } else {
            reviewsSummary.innerHTML = '<p class="text-zinc-500">Aún no hay reseñas para este producto. Sé el primero en dejar una.</p>';
        }

        document.getElementById('close-product-modal-btn').addEventListener('click', closeProductModal);
        document.getElementById('add-to-wishlist-btn-modal').addEventListener('click', () => toggleWishlist(product.id));
        productModalContent.querySelector('.btn-pago').addEventListener('click', () => handleBuyClick(product));
        
        const seeAllReviewsBtn = document.getElementById('see-all-reviews-btn');
        if (product.reviews.length > 0) {
            seeAllReviewsBtn.addEventListener('click', () => openReviewsModal(product));
        }

        // Manejador del botón de reseña condicional
        const leaveReviewBtn = document.getElementById('leave-review-btn');
        if (hasPurchased) {
            leaveReviewBtn.addEventListener('click', () => openReviewFormModal(product));
        } else {
            leaveReviewBtn.disabled = true;
            leaveReviewBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Manejador del cupón
        const couponBtn = document.getElementById('apply-coupon-btn');
        couponBtn.addEventListener('click', () => applyCoupon(product));
      };
      
      const openReviewsModal = (product) => {
        const avgRating = calculateAverageRating(product.reviews);
        
        let reviewsHtml = '';
        if (product.reviews.length > 0) {
            reviewsHtml = product.reviews.map(review => `
                <div class="bg-zinc-800 rounded-lg p-4 flex flex-col sm:flex-row gap-4 border border-zinc-700">
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <img src="${review.userImage}" alt="${review.author}" class="w-12 h-12 rounded-full">
                        <div>
                            <span class="block text-zinc-300 font-semibold">${review.author}</span>
                            <div class="star-rating read-only flex gap-1 text-yellow-400 text-lg">
                                ${'★'.repeat(review.rating)}
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow">
                        <p class="text-zinc-400 mb-2">${review.comment}</p>
                    </div>
                </div>
            `).join('');
        } else {
            reviewsHtml = '<p class="text-zinc-500 text-center">Aún no hay reseñas para este producto.</p>';
        }

        reviewsModalContent.innerHTML = `
            <div class="flex justify-between items-center mb-4 border-b border-zinc-700 pb-4 sticky top-0 bg-zinc-900 z-10">
                <h2 class="text-2xl font-bold text-white">Reseñas de ${product.name}</h2>
                <button id="close-reviews-modal-btn" class="text-zinc-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="flex items-center gap-2 mb-6">
                <div class="star-rating read-only text-3xl text-yellow-400">
                    ${'★'.repeat(Math.round(avgRating))}
                </div>
                <span class="text-zinc-400 text-xl font-bold">(${avgRating.toFixed(1)} de 5)</span>
            </div>
            <div class="space-y-4">
                ${reviewsHtml}
            </div>
        `;
        
        reviewsModal.classList.remove('opacity-0', 'pointer-events-none');
        reviewsModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
        
        document.getElementById('close-reviews-modal-btn').addEventListener('click', closeReviewsModal);
      };

      const closeReviewsModal = () => {
        reviewsModal.classList.add('opacity-0', 'pointer-events-none');
        reviewsModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
      };
      
      const openReviewFormModal = (product) => {
          reviewFormModalContent.innerHTML = `
              <div class="flex justify-between items-center mb-4 border-b border-zinc-700 pb-4">
                  <h2 class="text-2xl font-bold text-white">Tu reseña para ${product.name}</h2>
                  <button id="close-review-form-modal-btn" class="text-zinc-400 hover:text-white transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                  </button>
              </div>
              <form id="review-form">
                  <div class="mb-4">
                      <label class="block text-sm font-medium text-zinc-400 mb-2">Tu calificación</label>
                      <div id="star-rating-input" class="star-rating text-3xl text-yellow-400 flex items-center gap-2">
                          <span class="star" data-rating="1">★</span>
                          <span class="star" data-rating="2">★</span>
                          <span class="star" data-rating="3">★</span>
                          <span class="star" data-rating="4">★</span>
                          <span class="star" data-rating="5">★</span>
                      </div>
                  </div>
                  <div class="mb-4">
                      <label for="review-comment" class="block text-sm font-medium text-zinc-400 mb-2">Tu comentario (opcional)</label>
                      <textarea id="review-comment" rows="4" class="w-full rounded-lg bg-zinc-800 text-white border border-zinc-700 px-3 py-2 text-sm focus:ring-2 focus:ring-cyan-500 focus:outline-none placeholder-zinc-500"></textarea>
                  </div>
                  <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700 transition-colors">
                      Enviar Reseña
                  </button>
              </form>
          `;
          
          reviewFormModal.classList.remove('opacity-0', 'pointer-events-none');
          reviewFormModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
          
          let selectedRating = 0;
          const starRatingInput = document.getElementById('star-rating-input');
          starRatingInput.addEventListener('click', (e) => {
              const star = e.target.closest('.star');
              if (star) {
                  selectedRating = parseInt(star.dataset.rating);
                  starRatingInput.querySelectorAll('.star').forEach(s => {
                      if (parseInt(s.dataset.rating) <= selectedRating) {
                          s.classList.add('filled');
                          s.classList.remove('unfilled');
                      } else {
                          s.classList.add('unfilled');
                          s.classList.remove('filled');
                      }
                  });
              }
          });
          
          document.getElementById('review-form').addEventListener('submit', (e) => {
              e.preventDefault();
              if (selectedRating === 0) {
                  showToast('Por favor, selecciona una calificación.', 'error');
                  return;
              }
              const comment = document.getElementById('review-comment').value;
              addReview(product.id, selectedRating, comment);
              closeReviewFormModal();
              closeProductModal();
              showToast('¡Gracias por tu reseña!');
              renderContent(); // Refresca la UI para mostrar la nueva reseña
          });
          
          document.getElementById('close-review-form-modal-btn').addEventListener('click', closeReviewFormModal);
      };

      const closeReviewFormModal = () => {
          reviewFormModal.classList.add('opacity-0', 'pointer-events-none');
          reviewFormModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
      };
      
      const addReview = (productId, rating, comment) => {
          const product = allProducts.find(p => p.id === productId);
          if (product) {
              const newReview = {
                  rating: rating,
                  comment: comment || 'Sin comentario',
                  author: 'Usuario anónimo', // Podrías añadir un campo para el nombre si quieres
                  userImage: 'https://placehold.co/48x48/64748b/ffffff?text=U'
              };
              product.reviews.push(newReview);
              // Podrías guardar las reseñas en localStorage si quisieras persistirlas
              // userReviews[productId] = newReview;
              // localStorage.setItem('userReviews', JSON.stringify(userReviews));
          }
      };

      const applyCoupon = (product) => {
        const couponInput = document.getElementById('coupon-code');
        const couponMessage = document.getElementById('coupon-message');
        const modalPrice = document.getElementById('modal-price');
        
        if (couponInput.value.toUpperCase() === 'MYZONE10') {
            if (!product.couponApplied) {
                const originalPrice = parseFloat(modalPrice.textContent);
                const newPrice = originalPrice * 0.90;
                modalPrice.textContent = `${newPrice.toFixed(2)}€`;
                couponMessage.textContent = 'Cupón aplicado con éxito. ¡10% de descuento!';
                couponMessage.className = 'text-sm mt-2 text-green-500';
                product.couponApplied = true;
            } else {
                couponMessage.textContent = 'El cupón ya ha sido aplicado.';
                couponMessage.className = 'text-sm mt-2 text-yellow-500';
            }
        } else {
            couponMessage.textContent = 'El cupón no es válido.';
            couponMessage.className = 'text-sm mt-2 text-red-500';
            if (product.couponApplied) {
                modalPrice.textContent = `${product.price.toFixed(2)}€`;
                product.couponApplied = false;
            }
        }
        couponMessage.classList.remove('hidden');
      };

      const closeProductModal = () => {
        productModal.classList.add('opacity-0', 'pointer-events-none');
        productModalContent.classList.add('scale-95', 'opacity-0');
        body.classList.remove('no-scroll');
        allProducts.forEach(p => p.couponApplied = false);
      };

      // --- FUNCIÓN handleBuyClick ACTUALIZADA ---
      // Esta función ahora llama a la Vercel Function después de una compra exitosa.
      const handleBuyClick = async (product) => {
        const button = productModalContent.querySelector('.btn-pago');
        button.disabled = true;
        const buttonText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.spinner-container');
        buttonText.textContent = 'Procesando...';
        spinner.style.display = 'block';

        try {
          const paymentMessage = document.createElement('div');
          paymentMessage.className = 'text-center text-zinc-400 mt-4';
          paymentMessage.textContent = 'Estamos procesando tu pago de forma segura...';
          productModalContent.querySelector('.btn-pago').insertAdjacentElement('afterend', paymentMessage);
          
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
          });

          // --- INICIO DE LA NUEVA FUNCIONALIDAD ---
          // Aquí se hace la llamada a la función de Vercel.
          // El método `fetch` llama a la URL de tu función, que está en la carpeta 'api'.
          const apiResponse = await fetch('/api/enviar-correo.js', {
              method: 'POST'
          });

          if (apiResponse.ok) {
              console.log('Correo enviado correctamente por la Vercel Function.');
          } else {
              console.error('La Vercel Function devolvió un error.');
          }
          // --- FIN DE LA NUEVA FUNCIONALIDAD ---

          // Se actualiza el mensaje y se cierra el modal.
          paymentMessage.textContent = `¡Compra de "${product.name}" realizada con éxito!`;
          button.style.display = 'none';
          setTimeout(closeProductModal, 3000);

        } catch (error) {
          console.error("Error al procesar el pago: ", error);
          const paymentMessage = productModalContent.querySelector('.text-center.text-zinc-400');
          if (paymentMessage) paymentMessage.textContent = 'Error al procesar el pago. Por favor, inténtalo de nuevo.';
        } finally {
          button.disabled = false;
          buttonText.textContent = 'Comprar Ahora';
          spinner.style.display = 'none';
        }
      };
      
      /**
       * Crea una nueva oferta flash si no existe ninguna.
       * Esto se llama cuando el usuario hace clic en el enlace del menú.
       */
      const triggerFlashOffer = () => {
          if (flashOfferProduct) {
              showToast(`Ya hay una oferta flash activa para ${flashOfferProduct.name}. ¡Corre que se acaba!`, 'error');
              return;
          }
          
          const productsNotOnFlashOffer = allProducts.filter(p => !p.flashOffer);
          if (productsNotOnFlashOffer.length === 0) {
              showToast('No se puede crear una oferta flash, todos los productos ya están en oferta.', 'error');
              return;
          }
          
          const randomIndex = Math.floor(Math.random() * productsNotOnFlashOffer.length);
          const product = productsNotOnFlashOffer[randomIndex];
          
          product.flashOffer = {
              isFlashOffer: true,
              flashDiscount: Math.random() * (0.50 - 0.20) + 0.20,
          };
          flashOfferProduct = product;
          
          // Se ha adaptado el mensaje de la notificación al sistema de toasts
          const message = `¡Oferta relámpago! 🔥 "${product.name}" con un nuevo descuento.`;
          showToast(message);
          
          clearTimeout(flashOfferTimeout);
          flashOfferTimeout = setTimeout(() => {
              product.flashOffer = null;
              flashOfferProduct = null;
              showToast(`¡La oferta flash de ${product.name} ha terminado!`, 'error');
              currentSection = 'apps';
              renderContent();
              updateActiveLink();
          }, 30 * 1000);

          currentSection = 'flash-ofertas';
          renderContent();
          updateActiveLink();
          window.history.pushState({section: currentSection}, '', `#${currentSection}`);
      };

      /**
       * Lógica para el sistema de wishlist y notificaciones.
       */
      const toggleWishlist = (productId) => {
          const index = wishlist.indexOf(productId);
          if (index > -1) {
              wishlist.splice(index, 1);
              showToast('Producto eliminado de la lista de deseos.', 'error');
          } else {
              wishlist.push(productId);
              showToast('Producto añadido a la lista de deseos.');
          }
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
          renderContent(); // Refresca la UI para actualizar el icono
      };


      // --- EVENT LISTENERS ---
      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const newSection = e.target.closest('[data-section]').dataset.section;
          currentSection = newSection;
          
          // Lógica para ofertas flash: se dispara solo con el clic
          if (newSection === 'flash-ofertas' && !flashOfferProduct) {
              triggerFlashOffer();
          } else {
              renderContent();
              updateActiveLink();
              window.history.pushState({section: currentSection}, '', `#${currentSection}`);
          }
        });
      });
      
      startBrowseBtn.addEventListener('click', () => {
        currentSection = 'apps';
        renderContent();
        updateActiveLink();
        window.history.pushState({section: currentSection}, '', `#${currentSection}`);
      });
      
      window.addEventListener('popstate', (e) => {
          currentSection = e.state ? e.state.section : 'home';
          renderContent();
          updateActiveLink();
      });
      
      const handleCardClick = (e) => {
        const card = e.target.closest('.card, .offer-card');
        if (!card || e.target.closest('.buy-offer-btn')) return;
        const productId = card.dataset.productId;
        const product = allProducts.find(p => p.id === productId);
        if (product) openProductModal(product);
      };

      document.addEventListener('click', handleCardClick);
      
      productModal.addEventListener('click', (e) => {
        if (e.target === productModal) closeProductModal();
      });

      reviewsModal.addEventListener('click', (e) => {
        if (e.target === reviewsModal) closeReviewsModal();
      });

      reviewFormModal.addEventListener('click', (e) => {
        if (e.target === reviewFormModal) closeReviewFormModal();
      });
      
      simulateEventBtn.addEventListener('click', () => {
          const eligibleForPriceDrop = allProducts.filter(p => p.price >= p.originalPrice);
          const wishlistWithPriceDrop = wishlist.filter(id => eligibleForPriceDrop.some(p => p.id === id));
          
          if (wishlistWithPriceDrop.length > 0) {
              // Si hay productos en la wishlist con precio original, elegimos uno al azar para la oferta
              const randomIndex = Math.floor(Math.random() * wishlistWithPriceDrop.length);
              const productId = wishlistWithPriceDrop[randomIndex];
              const product = allProducts.find(p => p.id === productId);
              
              const newPrice = product.originalPrice * (Math.random() * (0.8 - 0.5) + 0.5); // 20-50% descuento
              product.price = parseFloat(newPrice.toFixed(2));
              
              const message = `¡Bajada de precio! 🎉 "${product.name}" ahora a ${product.price.toFixed(2)}€`;
              // Ahora se usa showToast en lugar de addNotification
              showToast(message, 'success');
              
              currentSection = 'ofertas';
              renderContent();
              updateActiveLink();
              window.history.pushState({section: currentSection}, '', `#${currentSection}`);
          } else {
              // Si no hay productos en la wishlist que cumplan la condición, o la lista está vacía, hacemos una oferta flash
              triggerFlashOffer();
          }
      });
      
      // --- INICIALIZACIÓN ---
      renderContent(); // Renderizado inicial con la nueva sección de bienvenida
      updateActiveLink();
      updateSalesCounters(); // Inicia la actualización de ventas simulada
      lucide.createIcons(); // Inicia los íconos dinámicos
    });
  </script>
</body>
</html>

